<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
  <title th:text="${home}">Title</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"/>

</head>
<body>
  <div class="container-fluid justify-content-center">
    <div class="row justify-content-center">
      <div class="col-10">
        <form method="POST" enctype="multipart/form-data" action="/upload">
          <label for="formFile" class="form-label"></label>
          <input name="file" type="file" class="form-control" id="formFile">
          <label for="modeSelect" class="form-label">
            <select name="mode" id="modeSelect">
              <option value="ECB">ECB</option>
              <option value="CBC">CBC</option>
              <option value="CFB">CFB</option>
              <option value="OFB">OFB</option>
              <option value="CTR">CTR</option>
              <option value="RD">RD</option>
              <option value="RDH">RDH</option>
            </select>
          </label>
          <button type="submit" class="btn btn-primary">Загрузить</button>
        </form>
      </div>
    </div>
  </div>
  <div class="progress">
    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
  </div>
  <div class="display-3" id="textRedirect" style="display: none">Файл загружен! Перенаправляем на главную....</div>
  <div style="visibility: hidden" th:text="${myId}" id="clientID"></div>
  <script>
    let id_ = document.getElementById('clientID').textContent;


    function updateProgressBar(progress) {
      let progressBar = document.getElementById('progress-bar');
      // let currentProgress = parseInt(progressBar.style.width) || 0;
      let newProgress = progress;
      progressBar.style.width = newProgress + '%';
      progressBar.setAttribute('aria-valuenow', newProgress);
      progressBar.innerText = newProgress + '%';
    }

    let id = setInterval(requestProgress, 100);// каждые 100 мсек выполняем запрос

    function requestProgress(){
      fetch('http://localhost:8081/progressUpload' + id_) // отправляет гет запрос
              .then(function (response) { // обрабатываем респонс
                if (response.ok) {
                  return response.json(); // возвращаем объект в виде json
                } else
                {
                  throw new Error('Ошибкаааааа (((');
                }
              })
              .then(function (responseJson){ // ловим респонс в виде json
                if (responseJson['state'] == "NOT_FOUND") {
                  clearTimeout(id);
                  updateProgressBar(0);
                  window.location.href = "http://localhost:8081" + responseJson["url"];
                } else if (responseJson['state'] == "WORKING"){
                  updateProgressBar(responseJson['progress']);

                } else {
                  console.log(responseJson['state'])
                  clearTimeout(id);
                  updateProgressBar(100);
                  document.getElementById("textRedirect").style.display = "block";
                  setTimeout(()=>window.location.replace( "http://localhost:8081/"), 1000);
                }
              })
              .catch(function (error) {
                console.log(error)
              })
    }

  </script>

</body>
</html>